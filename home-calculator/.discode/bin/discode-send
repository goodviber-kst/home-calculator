#!/usr/bin/env node
"use strict";

var path = require("path");
var http = require("http");

// Pre-configured by discode â€” just run this script, no setup needed.
var project  = "home-calculator";
var port     = 18470;
var agent    = process.env.AGENT_DISCORD_AGENT || "";
var instance = process.env.AGENT_DISCORD_INSTANCE || "";

var files = process.argv.slice(2);
if (files.length === 0) {
  console.error("Usage: discode-send <file1> [file2] ...");
  process.exit(1);
}

var resolved = files.map(function (f) { return path.resolve(f); });

var payload = JSON.stringify({
  projectName: project,
  agentType: agent || undefined,
  instanceId: instance || undefined,
  files: resolved,
});

var hostname = process.env.AGENT_DISCORD_HOSTNAME || "127.0.0.1";

var req = http.request(
  {
    hostname: hostname,
    port: port,
    path: "/send-files",
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Content-Length": Buffer.byteLength(payload),
    },
  },
  function (res) {
    var body = "";
    res.on("data", function (chunk) { body += chunk; });
    res.on("end", function () {
      if (res.statusCode >= 200 && res.statusCode < 300) {
        console.log("discode-send: sent " + resolved.length + " file(s)");
      } else {
        console.error("discode-send: server returned " + res.statusCode + ": " + body);
        process.exit(1);
      }
    });
  }
);

req.on("error", function (err) {
  console.error("discode-send: " + err.message);
  process.exit(1);
});

req.write(payload);
req.end();
